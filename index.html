<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Social Pro - AI Content Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .sidebar-icon {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-icon:hover {
            background-color: #3b82f6;
            color: white;
        }
        .nav-active {
            background-color: #2563eb;
            color: white;
        }
        .page {
            display: none;
        }
        .page-active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex h-screen bg-gray-100">

    <!-- Sidebar Navigation -->
    <aside class="w-20 lg:w-64 bg-white shadow-lg flex flex-col items-center lg:items-start p-4 transition-all duration-300">
        <div class="flex items-center justify-center lg:justify-start w-full mb-10">
            <svg class="h-10 w-10 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            <h1 class="text-2xl font-bold text-gray-800 ml-3 hidden lg:block">AgentPro</h1>
        </div>
        <nav class="w-full">
            <ul class="space-y-3">
                <li>
                    <a href="#" onclick="showPage('profile')" class="flex items-center p-3 rounded-lg sidebar-icon nav-active">
                        <i data-lucide="user-circle"></i>
                        <span class="ml-4 hidden lg:inline">Profile</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showPage('preset')" class="flex items-center p-3 rounded-lg sidebar-icon">
                        <i data-lucide="layout-grid"></i>
                        <span class="ml-4 hidden lg:inline">Content Library</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showPage('create')" class="flex items-center p-3 rounded-lg sidebar-icon">
                        <i data-lucide="sparkles"></i>
                        <span class="ml-4 hidden lg:inline">Create with AI</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showPage('dashboard')" class="flex items-center p-3 rounded-lg sidebar-icon">
                        <i data-lucide="bar-chart-3"></i>
                        <span class="ml-4 hidden lg:inline">Dashboard</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto flex items-center p-3 rounded-lg w-full text-gray-600">
             <i data-lucide="log-out"></i>
             <span class="ml-4 hidden lg:inline">Logout</span>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 lg:p-10 overflow-y-auto">

        <!-- Page: Profile Setup -->
        <div id="profile" class="page page-active">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Profile Setup</h2>
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-1 flex flex-col items-center">
                        <img id="profileImagePreview" src="https://placehold.co/200x200/E2E8F0/4A5568?text=Upload+Selfie" alt="Profile selfie" class="w-48 h-48 rounded-full object-cover mb-4 border-4 border-gray-200">
                        <label for="selfieUpload" class="cursor-pointer bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                            Upload Image
                        </label>
                        <input type="file" id="selfieUpload" class="hidden" accept="image/*">
                        <p class="text-xs text-gray-500 mt-2">PNG, JPG up to 5MB</p>
                    </div>
                    <div class="md:col-span-2">
                        <form id="profileForm" class="space-y-6">
                            <div>
                                <label for="agentName" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="agentName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="John Doe">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="agentPhone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                                    <input type="tel" id="agentPhone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="081-234-5678">
                                </div>
                                <div>
                                    <label for="agentEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                                    <input type="email" id="agentEmail" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="john.doe@email.com">
                                </div>
                            </div>
                            <div>
                                <label for="agentLine" class="block text-sm font-medium text-gray-700">LINE Account ID</label>
                                <input type="text" id="agentLine" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="@johndoe.insurance">
                            </div>
                             <div>
                                <label for="personality" class="block text-sm font-medium text-gray-700">Personality Tone: <span id="personalityLabel" class="font-semibold text-blue-600">Balanced</span></label>
                                <input type="range" id="personality" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center">
                                    <i data-lucide="save" class="mr-2"></i> Save Profile
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div id="socialLinks" class="mt-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Link Social Accounts</h3>
                 <div class="bg-white p-8 rounded-xl shadow-md">
                     <p class="text-gray-600 mb-4">Connect your accounts for easy sharing. (This is a demonstrative feature).</p>
                     <div class="flex space-x-4">
                        <button class="flex items-center justify-center w-full py-3 bg-blue-800 text-white rounded-lg hover:bg-blue-900 transition"><i data-lucide="facebook" class="mr-2"></i> Connect Facebook</button>
                        <button class="flex items-center justify-center w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition"><i data-lucide="instagram" class="mr-2"></i> Connect Instagram</button>
                        <button class="flex items-center justify-center w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"><i data-lucide="message-circle" class="mr-2"></i> Connect LINE</button>
                     </div>
                 </div>
            </div>
        </div>

        <!-- Page: Pre-set Content -->
        <div id="preset" class="page">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Content Library</h2>
            <p class="text-gray-600 mb-6">Select a template to personalize and share.</p>
            <div class="flex space-x-4 mb-6 border-b">
                <button onclick="filterContent('all')" class="content-filter-btn active-filter py-2 px-4 font-semibold text-blue-600 border-b-2 border-blue-600">All</button>
                <button onclick="filterContent('campaign')" class="content-filter-btn py-2 px-4 font-semibold text-gray-500">Quarterly Campaign</button>
                <button onclick="filterContent('lifecycle')" class="content-filter-btn py-2 px-4 font-semibold text-gray-500">Customer Lifecycle</button>
                <button onclick="filterContent('product')" class="content-filter-btn py-2 px-4 font-semibold text-gray-500">Free Coverage</button>
                <button onclick="filterContent('lifestyle')" class="content-filter-btn py-2 px-4 font-semibold text-gray-500">Lifestyle</button>
            </div>
            <div id="contentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Content cards will be injected here by JavaScript -->
            </div>
        </div>

        <!-- Page: Create Your Own -->
        <div id="create" class="page">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Create with AI</h2>
             <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Generation Form -->
                    <form id="aiCreateForm" class="space-y-6">
                        <div>
                            <label for="aiCategory" class="block text-sm font-medium text-gray-700">Content Category</label>
                            <select id="aiCategory" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option>Health Insurance Benefits</option>
                                <option>Retirement Planning</option>
                                <option>Investment-Linked Policies</option>
                                <option>Family Protection</option>
                                <option>General Financial Wellness</option>
                            </select>
                        </div>
                        <div>
                            <label for="aiTopic" class="block text-sm font-medium text-gray-700">Specific Topic (Optional)</label>
                            <input type="text" id="aiTopic" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., The importance of critical illness cover">
                        </div>
                        <div>
                            <label for="aiPrompt" class="block text-sm font-medium text-gray-700">Additional Instructions for AI</label>
                            <textarea id="aiPrompt" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Make it humorous, mention the upcoming holidays, target young professionals"></textarea>
                        </div>
                        <div class="flex items-center">
                            <input id="includeSelfieAI" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="includeSelfieAI" class="ml-2 block text-sm text-gray-900">Include my selfie in the generated image</label>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center">
                                <i data-lucide="sparkles" class="mr-2"></i> Generate Content
                            </button>
                        </div>
                    </form>

                    <!-- Generation Result -->
                    <div id="aiResultContainer" class="bg-gray-50 p-6 rounded-lg border border-dashed">
                        <div id="aiResultPlaceholder" class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                             <i data-lucide="wand-2" class="w-16 h-16 mb-4 text-gray-400"></i>
                            <h3 class="text-lg font-semibold">Your AI-generated content will appear here</h3>
                            <p class="text-sm">Fill out the form and click "Generate Content" to start.</p>
                        </div>
                        <div id="aiResultLoader" class="hidden flex-col items-center justify-center h-full">
                            <div class="loader"></div>
                            <p class="mt-4 text-gray-600">Generating your personalized content...</p>
                        </div>
                        <div id="aiResultContent" class="hidden">
                             <!-- Dynamic content will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page: Dashboard -->
        <div id="dashboard" class="page">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Content Performance</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="p-4 bg-blue-100 rounded-full"><i data-lucide="share-2" class="text-blue-600"></i></div>
                    <div class="ml-4">
                        <p class="text-gray-500">Total Shares</p>
                        <p class="text-2xl font-bold text-gray-800">128</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="p-4 bg-green-100 rounded-full"><i data-lucide="thumbs-up" class="text-green-600"></i></div>
                    <div class="ml-4">
                        <p class="text-gray-500">Total Reactions</p>
                        <p class="text-2xl font-bold text-gray-800">1,452</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="p-4 bg-yellow-100 rounded-full"><i data-lucide="message-square" class="text-yellow-600"></i></div>
                    <div class="ml-4">
                        <p class="text-gray-500">Total Comments</p>
                        <p class="text-2xl font-bold text-gray-800">312</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-8 rounded-xl shadow-md">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Recently Shared Content</h3>
                <div class="space-y-4">
                    <!-- Dashboard items -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                           <img src="https://placehold.co/80x80/93C5FD/FFFFFF?text=Post1" class="w-16 h-16 rounded-lg object-cover">
                           <div class="ml-4">
                               <p class="font-semibold text-gray-800">Secure Your Family's Future</p>
                               <p class="text-sm text-gray-500">Shared on Facebook - Oct 29, 2023</p>
                           </div>
                        </div>
                        <div class="flex space-x-6 text-gray-600">
                           <div class="flex items-center"><i data-lucide="thumbs-up" class="w-4 h-4 mr-1"></i> 58</div>
                           <div class="flex items-center"><i data-lucide="message-square" class="w-4 h-4 mr-1"></i> 12</div>
                           <div class="flex items-center"><i data-lucide="share-2" class="w-4 h-4 mr-1"></i> 22</div>
                        </div>
                    </div>
                     <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                           <img src="https://placehold.co/80x80/A7F3D0/FFFFFF?text=Post2" class="w-16 h-16 rounded-lg object-cover">
                           <div class="ml-4">
                               <p class="font-semibold text-gray-800">Retirement Planning Tips</p>
                               <p class="text-sm text-gray-500">Shared on LINE - Oct 27, 2023</p>
                           </div>
                        </div>
                        <div class="flex space-x-6 text-gray-600">
                           <div class="flex items-center"><i data-lucide="thumbs-up" class="w-4 h-4 mr-1"></i> 91</div>
                           <div class="flex items-center"><i data-lucide="message-square" class="w-4 h-4 mr-1"></i> 25</div>
                           <div class="flex items-center"><i data-lucide="share-2" class="w-4 h-4 mr-1"></i> 41</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </main>

    <!-- Modal for Content Personalization -->
    <div id="contentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-8" id="modalContent">
                <!-- Modal content will be injected here -->
            </div>
        </div>
    </div>


    <script>
        // --- App State and Data ---
        const agentProfile = {
            name: "Your Name",
            phone: "Your Phone",
            email: "your@email.com",
            line: "Your LINE ID",
            personality: "Balanced",
            personalityValue: 50,
            selfieUrl: "https://placehold.co/200x200/E2E8F0/4A5568?text=Upload+Selfie",
            base64Selfie: null,
            selfieMimeType: null
        };

        const presetContent = [
            { id: 1, category: 'campaign', title: 'Q4 Health Campaign', basePrompt: 'Write a compelling social media post about our special Q4 health insurance campaign. Emphasize the limited-time offers and the benefit of getting covered before the year ends.', imgPrompt: 'An uplifting image representing health and vitality in autumn, with warm colors. A family is enjoying an outdoor activity.' },
            { id: 2, category: 'lifecycle', title: 'First Job Insurance', basePrompt: 'Create a short, encouraging post for young professionals starting their first job. The topic is the importance of getting a basic insurance plan early in their career.', imgPrompt: 'A vibrant image of a diverse group of young professionals collaborating in a modern office setting, looking confident and happy.' },
            { id: 3, category: 'product', title: 'Free Cancer Coverage', basePrompt: 'Announce a free cancer coverage add-on for a limited time when signing up for a primary health plan. The tone should be informative and reassuring.', imgPrompt: 'A clean, minimalist image with a pink ribbon symbol and a protective, gentle hand gesture. The mood is hopeful and supportive.' },
            { id: 4, category: 'lifestyle', title: 'Weekend Wellness Tip', basePrompt: 'Write a lighthearted lifestyle post offering a simple wellness tip for the weekend. Connect it subtly to the idea of long-term well-being and planning.', imgPrompt: 'A serene and aesthetic image of a person enjoying a simple weekend pleasure, like reading a book by a window, a cup of tea, or practicing yoga at sunrise.' },
            { id: 5, category: 'campaign', title: 'Year-End Tax Savings', basePrompt: 'Generate a post about using insurance policies for tax deductions before the end of the fiscal year. Make it easy to understand and highlight the dual benefit of protection and savings.', imgPrompt: 'A professional and clear graphic with icons representing a piggy bank, a tax document, and a shield. The color scheme is green and gold.' },
            { id: 6, category: 'lifecycle', title: 'Protecting Your Family', basePrompt: 'Create a warm, heartfelt post about the peace of mind that comes with securing your family\'s future through life insurance. Use storytelling to evoke emotion.', imgPrompt: 'A warm, candid-style photo of a multi-generational family sharing a happy moment, like laughing together in a park or home.' },
        ];
        
        // --- Navigation ---
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.sidebar-icon');

        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.remove('page-active');
            });
            document.getElementById(pageId).classList.add('page-active');
            
            navLinks.forEach(link => {
                link.classList.remove('nav-active');
                if (link.getAttribute('onclick').includes(pageId)) {
                    link.classList.add('nav-active');
                }
            });
        }
        
        // --- Profile Setup Logic ---
        const profileForm = document.getElementById('profileForm');
        const selfieUpload = document.getElementById('selfieUpload');
        const profileImagePreview = document.getElementById('profileImagePreview');
        const personalitySlider = document.getElementById('personality');
        const personalityLabel = document.getElementById('personalityLabel');

        selfieUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const dataUrl = event.target.result;
                    agentProfile.selfieUrl = dataUrl;
                    profileImagePreview.src = dataUrl;
                    
                    // Store base64 and mimeType for API usage
                    const parts = dataUrl.split(',');
                    const mimeTypePart = parts[0].match(/:(.*?);/);
                     if (mimeTypePart && mimeTypePart[1]) {
                        agentProfile.selfieMimeType = mimeTypePart[1];
                    } else {
                        agentProfile.selfieMimeType = 'image/jpeg'; // fallback
                    }
                    agentProfile.base64Selfie = parts[1];
                }
                reader.readAsDataURL(file);
            }
        });

        const personalityMap = {
            0: "Very Friendly", 25: "Friendly", 50: "Balanced", 75: "Professional", 100: "Very Professional"
        };
        
        personalitySlider.addEventListener('input', (e) => {
            const value = e.target.value;
            let label = "Balanced";
            if (value <= 15) label = personalityMap[0];
            else if (value <= 40) label = personalityMap[25];
            else if (value <= 60) label = personalityMap[50];
            else if (value <= 85) label = personalityMap[75];
            else label = personalityMap[100];
            personalityLabel.textContent = label;
            agentProfile.personality = label;
            agentProfile.personalityValue = value;
        });

        profileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            agentProfile.name = document.getElementById('agentName').value;
            agentProfile.phone = document.getElementById('agentPhone').value;
            agentProfile.email = document.getElementById('agentEmail').value;
            agentProfile.line = document.getElementById('agentLine').value;
            alert('Profile saved successfully!');
            renderContentGrid(); // Re-render content with new profile info
        });

        // --- Content Library Logic ---
        const contentGrid = document.getElementById('contentGrid');
        const contentFilterBtns = document.querySelectorAll('.content-filter-btn');

        function filterContent(category) {
            renderContentGrid(category);
            contentFilterBtns.forEach(btn => btn.classList.remove('active-filter', 'text-blue-600', 'border-blue-600'));
            const activeBtn = document.querySelector(`.content-filter-btn[onclick="filterContent('${category}')"]`);
            activeBtn.classList.add('active-filter', 'text-blue-600', 'border-blue-600');
        }

        function renderContentGrid(category = 'all') {
            contentGrid.innerHTML = '';
            const filteredContent = category === 'all' 
                ? presetContent 
                : presetContent.filter(item => item.category === category);
            
            filteredContent.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-xl transition-shadow duration-300';
                card.onclick = () => openContentModal(item.id);
                card.innerHTML = `
                    <div class="h-40 bg-gray-200 flex items-center justify-center">
                        <img src="https://placehold.co/400x200/BFDBFE/1E40AF?text=${item.title.replace(' ', '+')}" class="w-full h-full object-cover"/>
                    </div>
                    <div class="p-4">
                        <p class="text-sm font-semibold text-blue-600">${item.category.charAt(0).toUpperCase() + item.category.slice(1)}</p>
                        <h3 class="text-lg font-bold text-gray-800">${item.title}</h3>
                    </div>
                `;
                contentGrid.appendChild(card);
            });
        }
        
        // --- Modal & Personalization Logic ---
        const contentModal = document.getElementById('contentModal');
        const modalContent = document.getElementById('modalContent');
        
        async function openContentModal(contentId) {
            const item = presetContent.find(c => c.id === contentId);
            if (!item) return;

            // Show initial modal with options before generating
            modalContent.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-3xl font-bold text-gray-800">${item.title}</h2>
                    <button onclick="closeContentModal()" class="p-2 -mr-2 -mt-2 text-gray-400 hover:text-gray-700 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="text-center p-6 border-t">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Personalization Options</h3>
                    <div class="flex items-center justify-center mb-6">
                        <input id="includeSelfieModal" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="includeSelfieModal" class="ml-3 block text-md text-gray-900">Include my selfie in the generated image</label>
                    </div>
                    <button id="generateModalContentBtn" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center mx-auto">
                        <i data-lucide="sparkles" class="mr-2"></i> Generate Personalized Content
                    </button>
                </div>
            `;
            lucide.createIcons();
            contentModal.style.display = 'flex';

            // Add event listener to the generate button inside the modal
            document.getElementById('generateModalContentBtn').onclick = async () => {
                const includeSelfie = document.getElementById('includeSelfieModal').checked;

                modalContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-10">
                        <div class="loader"></div>
                        <p class="mt-4 text-gray-600">Personalizing your content with AI...</p>
                    </div>`;

                const [generatedText, generatedImageUrl] = await Promise.all([
                    generateText(item.basePrompt),
                    generateImage(item.imgPrompt, includeSelfie)
                ]);
                
                modalContent.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">${item.title}</h2>
                         <button onclick="closeContentModal()" class="p-2 -mr-2 -mt-2 text-gray-400 hover:text-gray-700 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="relative group">
                            <img id="generatedImage" src="${generatedImageUrl}" class="rounded-lg shadow-lg w-full aspect-square object-cover">
                            <!-- Agent Info Overlay -->
                            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white p-4 rounded-b-lg">
                               <div class="flex items-center">
                                   <img src="${agentProfile.selfieUrl}" class="w-12 h-12 rounded-full border-2 border-white object-cover">
                                   <div class="ml-3">
                                       <p class="font-bold text-md">${agentProfile.name}</p>
                                       <p class="text-xs">${agentProfile.phone} | ${agentProfile.email}</p>
                                   </div>
                               </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Generated Post Content</h3>
                            <textarea id="generatedText" class="w-full h-64 border-gray-300 rounded-md p-4 bg-gray-50">${generatedText}</textarea>
                            <div class="mt-6 flex space-x-3">
                                <button class="flex-1 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition flex items-center justify-center"><i data-lucide="message-circle" class="mr-2"></i> Share on LINE</button>
                                <button class="flex-1 bg-blue-800 text-white py-3 rounded-lg font-semibold hover:bg-blue-900 transition flex items-center justify-center"><i data-lucide="facebook" class="mr-2"></i> Share on Facebook</button>
                                <button class="flex-1 bg-pink-500 text-white py-3 rounded-lg font-semibold hover:bg-pink-600 transition flex items-center justify-center"><i data-lucide="instagram" class="mr-2"></i> Share on Instagram</button>
                            </div>
                        </div>
                    </div>
                `;
                 lucide.createIcons();
            };
        }

        function closeContentModal() {
            contentModal.style.display = 'none';
        }
        
        contentModal.addEventListener('click', closeContentModal);

        // --- AI Generation Logic ---
        const aiCreateForm = document.getElementById('aiCreateForm');
        
        aiCreateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = document.getElementById('aiCategory').value;
            const topic = document.getElementById('aiTopic').value;
            const instructions = document.getElementById('aiPrompt').value;
            const includeSelfie = document.getElementById('includeSelfieAI').checked;
            
            const aiResultPlaceholder = document.getElementById('aiResultPlaceholder');
            const aiResultLoader = document.getElementById('aiResultLoader');
            const aiResultContent = document.getElementById('aiResultContent');

            aiResultPlaceholder.classList.add('hidden');
            aiResultContent.classList.add('hidden');
            aiResultLoader.style.display = 'flex';

            const textPrompt = `Create a social media post about "${category}". The specific topic is "${topic}". Additional instructions: "${instructions}".`;
            const imagePrompt = `An inspiring and professional image suitable for a social media post about "${category}" and "${topic}". ${instructions}`;
            
            const [generatedText, generatedImageUrl] = await Promise.all([
                generateText(textPrompt),
                generateImage(imagePrompt, includeSelfie)
            ]);
            
            aiResultContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4">Generated Content</h3>
                <div class="relative mb-4">
                   <img src="${generatedImageUrl}" class="rounded-lg shadow-lg w-full aspect-square object-cover">
                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white p-3 rounded-b-lg">
                       <div class="flex items-center">
                           <img src="${agentProfile.selfieUrl}" class="w-10 h-10 rounded-full border-2 border-white object-cover">
                           <div class="ml-2">
                               <p class="font-bold text-sm">${agentProfile.name}</p>
                               <p class="text-xs opacity-90">${agentProfile.phone}</p>
                           </div>
                       </div>
                    </div>
                </div>
                <textarea class="w-full h-48 border-gray-300 rounded-md p-3 bg-gray-50">${generatedText}</textarea>
                <div class="mt-4 flex space-x-2">
                    <button class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Share</button>
                    <button class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Edit</button>
                </div>`;
            
            aiResultLoader.style.display = 'none';
            aiResultContent.classList.remove('hidden');
             lucide.createIcons();
        });

        // --- Gemini API Call Functions ---
        const API_KEY = ""; // Kept empty as per instructions for Canvas environment.
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const IMAGE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;

        async function generateText(prompt) {
            const systemInstruction = `You are a social media content writer for an insurance agent named ${agentProfile.name}. Your tone should be ${agentProfile.personality}. Keep the post concise, engaging, and end with a call to action to contact ${agentProfile.name}. Do not use hashtags.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
            };

            try {
                const response = await fetch(TEXT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    console.error("API Error Response:", await response.text());
                    return "Error: Could not generate text. Please check your setup.";
                }
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error fetching from text API:", error);
                return "Failed to generate text due to a network error.";
            }
        }

        async function generateImage(prompt, includeSelfie = false) {
             if (includeSelfie && agentProfile.base64Selfie) {
                // Use gemini-2.5-flash-image-preview for image-to-image generation
                const FLASH_IMAGE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`;
                
                const finalPrompt = `Using the person in the provided image as a character, create a new image based on this theme: "${prompt}". The character should be naturally integrated into the scene.`;
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: finalPrompt },
                            {
                                inlineData: {
                                    mimeType: agentProfile.selfieMimeType || 'image/jpeg',
                                    data: agentProfile.base64Selfie
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ['IMAGE']
                    },
                };

                try {
                    const response = await fetch(FLASH_IMAGE_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        console.error("API Error Response (flash-image):", await response.text());
                        return "https://placehold.co/512x512/FF0000/FFFFFF?text=Selfie+Gen+Error";
                    }
                    const result = await response.json();
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (base64Data) {
                        return `data:image/png;base64,${base64Data}`;
                    } else {
                        console.error("No image data in flash-image response", result);
                        return "https://placehold.co/512x512/CCCCCC/FFFFFF?text=No+Selfie+Image";
                    }
                } catch (error) {
                    console.error("Error fetching from flash image API:", error);
                    return "https://placehold.co/512x512/FFC107/FFFFFF?text=Network+Error";
                }

            } else {
                 // Use imagen-3.0-generate-002 for standard text-to-image
                 const payload = { 
                    instances: [{ prompt: prompt }],
                    parameters: { "sampleCount": 1 }
                 };
                try {
                    const response = await fetch(IMAGE_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                     if (!response.ok) {
                        console.error("API Error Response (imagen):", await response.text());
                        return "https://placehold.co/512x512/FF0000/FFFFFF?text=Image+Gen+Error";
                    }
                    const result = await response.json();
                    if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                        return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    }
                    return "https://placehold.co/512x512/CCCCCC/FFFFFF?text=No+Image+Returned";
                } catch (error) {
                    console.error("Error fetching from image API:", error);
                    return "https://placehold.co/512x512/FFC107/FFFFFF?text=Network+Error";
                }
            }
        }

        // --- Initial Load ---
        window.onload = () => {
            lucide.createIcons();
            showPage('profile');
            renderContentGrid();
        };

    </script>
</body>
</html>

